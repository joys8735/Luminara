/**\n * Migration Manager Service\n * Manages migration from localStorage to Supabase\n * \n * Validates: Requirements 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7\n */\n\nimport { MigrationData, MigrationResult, PointsData } from '../types';\nimport { storageManager } from './StorageManager';\nimport { transactionManager } from './TransactionManager';\nimport { getCurrentTimestamp } from '../utils';\n\nexport class MigrationManager {\n  private supabaseClient: any;\n\n  constructor(supabaseClient?: any) {\n    this.supabaseClient = supabaseClient;\n  }\n\n  /**\n   * Set Supabase client\n   */\n  setSupabaseClient(client: any): void {\n    this.supabaseClient = client;\n  }\n\n  /**\n   * Read data from localStorage\n   * Requirement 6.1: Read all points data from localStorage\n   */\n  readFromLocalStorage(userId: string): MigrationData | null {\n    try {\n      // Try to read from old localStorage keys\n      const alphaPointsKey = `alpha_points_${userId}`;\n      const rewardPointsKey = `reward_points_${userId}`;\n      const platformBalanceKey = `platform_balance_${userId}`;\n      const achievementsKey = `achievements_${userId}`;\n\n      const alphaPoints = parseInt(localStorage.getItem(alphaPointsKey) || '0', 10);\n      const rewardPoints = parseInt(localStorage.getItem(rewardPointsKey) || '0', 10);\n      const platformBalance = parseInt(localStorage.getItem(platformBalanceKey) || '0', 10);\n\n      let achievements: Array<{ id: string; unlockedAt: string }> = [];\n      const achievementsData = localStorage.getItem(achievementsKey);\n      if (achievementsData) {\n        try {\n          achievements = JSON.parse(achievementsData);\n        } catch (error) {\n          console.error('Failed to parse achievements:', error);\n        }\n      }\n\n      // Check if any data exists\n      if (alphaPoints === 0 && rewardPoints === 0 && platformBalance === 0 && achievements.length === 0) {\n        return null;\n      }\n\n      return {\n        alphaPoints,\n        rewardPoints,\n        platformBalance,\n        achievements,\n      };\n    } catch (error) {\n      console.error('Failed to read from localStorage:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Validate migration data\n   * Requirement 6.2: Validate data integrity before transfer\n   */\n  validateData(data: MigrationData): { valid: boolean; errors: string[] } {\n    const errors: string[] = [];\n\n    // Validate points are non-negative integers\n    if (!Number.isInteger(data.alphaPoints) || data.alphaPoints < 0) {\n      errors.push('Invalid alpha points: must be non-negative integer');\n    }\n\n    if (!Number.isInteger(data.rewardPoints) || data.rewardPoints < 0) {\n      errors.push('Invalid reward points: must be non-negative integer');\n    }\n\n    if (!Number.isInteger(data.platformBalance) || data.platformBalance < 0) {\n      errors.push('Invalid platform balance: must be non-negative integer');\n    }\n\n    // Validate achievements array\n    if (!Array.isArray(data.achievements)) {\n      errors.push('Achievements must be an array');\n    } else {\n      data.achievements.forEach((achievement, index) => {\n        if (!achievement.id || typeof achievement.id !== 'string') {\n          errors.push(`Achievement ${index}: missing or invalid id`);\n        }\n        if (!achievement.unlockedAt || typeof achievement.unlockedAt !== 'string') {\n          errors.push(`Achievement ${index}: missing or invalid unlockedAt`);\n        }\n      });\n    }\n\n    return {\n      valid: errors.length === 0,\n      errors,\n    };\n  }\n\n  /**\n   * Migrate to Supabase\n   * Requirement 6.3, 6.4: Create records in Supabase and transaction records\n   */\n  async migrateToSupabase(userId: string, data: MigrationData): Promise<MigrationResult> {\n    if (!this.supabaseClient) {\n      return {\n        success: false,\n        migratedRecords: 0,\n        transactionsCreated: 0,\n        error: 'Supabase client not configured',\n      };\n    }\n\n    try {\n      // Validate data\n      const validation = this.validateData(data);\n      if (!validation.valid) {\n        return {\n          success: false,\n          migratedRecords: 0,\n          transactionsCreated: 0,\n          error: `Validation failed: ${validation.errors.join(', ')}`,\n        };\n      }\n\n      const timestamp = getCurrentTimestamp();\n      let migratedRecords = 0;\n      let transactionsCreated = 0;\n\n      // Create points record\n      const { error: pointsError } = await this.supabaseClient\n        .from('points')\n        .upsert(\n          {\n            user_id: userId,\n            alpha_points: data.alphaPoints,\n            reward_points: data.rewardPoints,\n            platform_balance: data.platformBalance,\n            last_updated: timestamp,\n          },\n          { onConflict: 'user_id' }\n        );\n\n      if (pointsError) {\n        return {\n          success: false,\n          migratedRecords: 0,\n          transactionsCreated: 0,\n          error: `Failed to create points record: ${pointsError.message}`,\n        };\n      }\n\n      migratedRecords++;\n\n      // Create transaction records for migrated data\n      if (data.alphaPoints > 0) {\n        const { error: txError } = await this.supabaseClient.from('transactions').insert({\n          user_id: userId,\n          operation_type: 'migration',\n          points_type: 'alpha',\n          amount: data.alphaPoints,\n          reason: 'Migrated from localStorage',\n          balance_before: 0,\n          balance_after: data.alphaPoints,\n          timestamp,\n        });\n\n        if (!txError) {\n          transactionsCreated++;\n        }\n      }\n\n      if (data.rewardPoints > 0) {\n        const { error: txError } = await this.supabaseClient.from('transactions').insert({\n          user_id: userId,\n          operation_type: 'migration',\n          points_type: 'rewards',\n          amount: data.rewardPoints,\n          reason: 'Migrated from localStorage',\n          balance_before: 0,\n          balance_after: data.rewardPoints,\n          timestamp,\n        });\n\n        if (!txError) {\n          transactionsCreated++;\n        }\n      }\n\n      if (data.platformBalance > 0) {\n        const { error: txError } = await this.supabaseClient.from('transactions').insert({\n          user_id: userId,\n          operation_type: 'migration',\n          points_type: 'balance',\n          amount: data.platformBalance,\n          reason: 'Migrated from localStorage',\n          balance_before: 0,\n          balance_after: data.platformBalance,\n          timestamp,\n        });\n\n        if (!txError) {\n          transactionsCreated++;\n        }\n      }\n\n      // Migrate achievements\n      for (const achievement of data.achievements) {\n        const { error: achError } = await this.supabaseClient.from('user_achievements').insert({\n          user_id: userId,\n          achievement_id: achievement.id,\n          unlocked_at: achievement.unlockedAt,\n        });\n\n        if (!achError) {\n          migratedRecords++;\n        }\n      }\n\n      return {\n        success: true,\n        migratedRecords,\n        transactionsCreated,\n      };\n    } catch (error) {\n      return {\n        success: false,\n        migratedRecords: 0,\n        transactionsCreated: 0,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      };\n    }\n  }\n\n  /**\n   * Check if user is migrated\n   * Requirement 6.6: Prevent duplicate migrations\n   */\n  async isMigrated(userId: string): Promise<boolean> {\n    return storageManager.isMigrated(userId);\n  }\n\n  /**\n   * Mark as migrated\n   */\n  async markAsMigrated(userId: string): Promise<void> {\n    storageManager.setMigrated(userId, true);\n\n    // Also mark in Supabase\n    if (this.supabaseClient) {\n      try {\n        await this.supabaseClient.from('migration_status').upsert(\n          {\n            user_id: userId,\n            migrated: true,\n            migrated_at: getCurrentTimestamp(),\n          },\n          { onConflict: 'user_id' }\n        );\n      } catch (error) {\n        console.error('Failed to mark migration in Supabase:', error);\n      }\n    }\n  }\n\n  /**\n   * Perform full migration\n   */\n  async performMigration(userId: string): Promise<MigrationResult> {\n    // Check if already migrated\n    if (await this.isMigrated(userId)) {\n      return {\n        success: false,\n        migratedRecords: 0,\n        transactionsCreated: 0,\n        error: 'User already migrated',\n      };\n    }\n\n    // Read from localStorage\n    const data = this.readFromLocalStorage(userId);\n    if (!data) {\n      return {\n        success: false,\n        migratedRecords: 0,\n        transactionsCreated: 0,\n        error: 'No data found in localStorage',\n      };\n    }\n\n    // Migrate to Supabase\n    const result = await this.migrateToSupabase(userId, data);\n\n    if (result.success) {\n      // Mark as migrated\n      await this.markAsMigrated(userId);\n    }\n\n    return result;\n  }\n}\n\n// Export singleton instance\nexport const migrationManager = new MigrationManager();\n