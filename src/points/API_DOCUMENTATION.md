# Unified Points System - API Documentation\n\n## Table of Contents\n\n1. [Initialization](#initialization)\n2. [Points API](#points-api)\n3. [Achievement API](#achievement-api)\n4. [Level API](#level-api)\n5. [Transaction API](#transaction-api)\n6. [Event System](#event-system)\n7. [Error Handling](#error-handling)\n8. [React Hooks](#react-hooks)\n9. [Examples](#examples)\n\n## Initialization\n\n### Initialize Points System\n\n```typescript\nimport { initializePointsSystem } from '@/points';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabaseClient = createClient(url, key);\n\ninitializePointsSystem({\n  supabaseClient,\n  enableLogging: true,\n});\n```\n\n## Points API\n\n### Add Points\n\nAdd points to a user's account.\n\n```typescript\nimport { pointsAPI } from '@/points';\n\nconst result = await pointsAPI.addPoints(\n  'user-123',           // userId\n  100,                  // amount\n  'rewards',            // pointsType: 'alpha' | 'rewards' | 'balance'\n  'Daily login bonus'   // reason\n);\n\nif (result.success) {\n  console.log('Points added:', result.transaction);\n  console.log('Operation ID:', result.operationId);\n} else {\n  console.error('Error:', result.error);\n}\n```\n\n**Parameters:**\n- `userId` (string): User identifier\n- `amount` (number): Points to add (must be > 0)\n- `pointsType` (PointsType): Type of points\n- `reason` (string): Reason for the operation\n\n**Returns:**\n```typescript\n{\n  success: boolean;\n  transaction?: Transaction;  // Created transaction\n  error?: string;             // Error message if failed\n  operationId?: string;       // For debugging\n}\n```\n\n### Subtract Points\n\nSubtract points from a user's account.\n\n```typescript\nconst result = await pointsAPI.subtractPoints(\n  'user-123',\n  50,\n  'balance',\n  'Purchase item'\n);\n\nif (!result.success) {\n  if (result.error?.includes('Insufficient')) {\n    console.log('Not enough points');\n  }\n}\n```\n\n**Parameters:**\n- `userId` (string): User identifier\n- `amount` (number): Points to subtract\n- `pointsType` (PointsType): Type of points\n- `reason` (string): Reason for the operation\n\n**Returns:** Same as addPoints\n\n**Errors:**\n- `INSUFFICIENT_BALANCE`: Not enough points\n- `INVALID_AMOUNT`: Amount <= 0\n- `USER_NOT_FOUND`: User doesn't exist\n\n### Transfer Points\n\nTransfer points between users.\n\n```typescript\nconst result = await pointsAPI.transferPoints(\n  'user-123',           // fromUserId\n  'user-456',           // toUserId\n  100,                  // amount\n  'rewards',            // pointsType\n  'Gift transfer'       // reason\n);\n\nif (result.success) {\n  console.log('Transactions:', result.transactions);\n  // Returns array with 2 transactions: one for sender, one for receiver\n}\n```\n\n**Parameters:**\n- `fromUserId` (string): Sender user ID\n- `toUserId` (string): Receiver user ID\n- `amount` (number): Points to transfer\n- `pointsType` (PointsType): Type of points\n- `reason` (string): Reason for transfer\n\n**Returns:**\n```typescript\n{\n  success: boolean;\n  transactions?: Transaction[];  // Two transactions created\n  error?: string;\n  operationId?: string;\n}\n```\n\n### Batch Operations\n\nExecute multiple operations atomically.\n\n```typescript\nconst result = await pointsAPI.batchOperations([\n  {\n    type: 'add',\n    userId: 'user-1',\n    amount: 100,\n    pointsType: 'rewards',\n    reason: 'Bonus'\n  },\n  {\n    type: 'subtract',\n    userId: 'user-2',\n    amount: 50,\n    pointsType: 'balance',\n    reason: 'Fee'\n  },\n  {\n    type: 'transfer',\n    userId: 'user-1',\n    toUserId: 'user-3',\n    amount: 100,\n    pointsType: 'rewards',\n    reason: 'Gift'\n  }\n]);\n\nif (result.success) {\n  console.log('All operations succeeded');\n  console.log('Transactions:', result.transactions);\n} else {\n  console.log('Some operations failed:', result.errors);\n}\n```\n\n**Returns:**\n```typescript\n{\n  success: boolean;           // true if all succeeded\n  transactions: Transaction[];\n  errors: string[];           // Error messages for failed ops\n}\n```\n\n### Get Points\n\nRetrieve user's current points.\n\n```typescript\nconst points = await pointsAPI.getPoints('user-123');\n\nif (points) {\n  console.log('Alpha:', points.alpha);\n  console.log('Rewards:', points.rewards);\n  console.log('Balance:', points.balance);\n}\n```\n\n**Returns:**\n```typescript\n{\n  userId: string;\n  alpha: number;\n  rewards: number;\n  balance: number;\n  lastUpdated: string;  // ISO timestamp\n}\n```\n\n### Get Balance\n\nGet balance for specific points type.\n\n```typescript\nconst balance = await pointsAPI.getBalance('user-123', 'rewards');\nconsole.log('Reward points:', balance);\n```\n\n## Achievement API\n\n### Get Achievements\n\n```typescript\nimport { achievementManager } from '@/points';\n\nconst achievements = achievementManager.getAchievements();\n\nachievements.forEach(achievement => {\n  console.log(`${achievement.name}: ${achievement.pointsThreshold} points`);\n});\n```\n\n### Get User Achievements\n\n```typescript\nconst userAchievements = achievementManager.getUserAchievements('user-123');\n\nuserAchievements.forEach(ua => {\n  console.log(`Unlocked: ${ua.achievementId} at ${ua.unlockedAt}`);\n});\n```\n\n### Check and Unlock Achievements\n\n```typescript\nconst unlockedAchievements = achievementManager.checkAndUnlockAchievements(\n  'user-123',\n  500  // totalPoints\n);\n\nif (unlockedAchievements.length > 0) {\n  console.log('New achievements unlocked!');\n  unlockedAchievements.forEach(achievement => {\n    console.log(`${achievement.name}: +${achievement.rewardPoints} points`);\n  });\n}\n```\n\n### Get Achievement Progress\n\n```typescript\nconst progress = achievementManager.getProgress('user-123', 250);\n\nconsole.log(`Unlocked: ${progress.unlockedCount}/${progress.totalCount}`);\nif (progress.nextAchievement) {\n  console.log(`Next: ${progress.nextAchievement.name}`);\n  console.log(`Points needed: ${progress.nextThreshold - 250}`);\n}\n```\n\n## Level API\n\n### Get User Level\n\n```typescript\nimport { levelManager } from '@/points';\n\nconst levelData = levelManager.getUserLevel('user-123');\n\nif (levelData) {\n  console.log(`Level: ${levelData.currentLevel}`);\n  console.log(`Total Points: ${levelData.totalPoints}`);\n}\n```\n\n### Check Level Up\n\n```typescript\nconst result = levelManager.checkLevelUp('user-123', 500);\n\nif (result.leveledUp) {\n  console.log(`Level up! ${result.oldLevel} → ${result.newLevel}`);\n  console.log(`Bonus: +${result.bonusPoints} points`);\n}\n```\n\n### Get Progress to Next Level\n\n```typescript\nconst progress = levelManager.getProgressToNextLevel(250);\n\nconsole.log(`Current Level: ${progress.currentLevel}`);\nconsole.log(`Next Level: ${progress.nextLevel}`);\nconsole.log(`Progress: ${progress.progressPercentage.toFixed(1)}%`);\nconsole.log(`Points needed: ${progress.pointsNeededForNextLevel}`);\n```\n\n## Transaction API\n\n### Get Transaction History\n\n```typescript\nimport { transactionManager } from '@/points';\n\nconst history = transactionManager.getHistory('user-123');\n\nhistory.forEach(tx => {\n  console.log(`${tx.operationType}: ${tx.amount} ${tx.pointsType}`);\n});\n```\n\n### Filter Transactions\n\n```typescript\n// By points type\nconst rewards = transactionManager.getHistory('user-123', {\n  pointsType: 'rewards'\n});\n\n// By operation type\nconst transfers = transactionManager.getHistory('user-123', {\n  operationType: 'transfer'\n});\n\n// By date range\nconst thisMonth = transactionManager.getHistory('user-123', {\n  startDate: '2024-01-01T00:00:00Z',\n  endDate: '2024-01-31T23:59:59Z'\n});\n\n// Combined filters\nconst filtered = transactionManager.getHistory('user-123', {\n  pointsType: 'rewards',\n  operationType: 'add',\n  startDate: '2024-01-01T00:00:00Z'\n});\n```\n\n### Get Statistics\n\n```typescript\nconst stats = transactionManager.getStatistics('user-123');\n\nconsole.log(`Total transactions: ${stats.totalTransactions}`);\nconsole.log(`Total added: ${stats.totalAdded}`);\nconsole.log(`Total subtracted: ${stats.totalSubtracted}`);\nconsole.log(`Rewards added: ${stats.byType.rewards.added}`);\n```\n\n## Event System\n\n### Subscribe to Events\n\n```typescript\nimport { eventSystem } from '@/points';\n\n// Points changed\nconst unsubscribe1 = eventSystem.on('points-changed', (event) => {\n  console.log(`User ${event.userId} now has ${event.newBalance} points`);\n});\n\n// Achievement unlocked\nconst unsubscribe2 = eventSystem.on('achievement-unlocked', (event) => {\n  console.log(`${event.achievement.name} unlocked! +${event.bonusPoints} points`);\n});\n\n// Level up\nconst unsubscribe3 = eventSystem.on('level-up', (event) => {\n  console.log(`Level up to ${event.newLevel}! +${event.bonusPoints} points`);\n});\n\n// Sync complete\nconst unsubscribe4 = eventSystem.on('sync-complete', (event) => {\n  console.log('Data synced with server');\n});\n\n// Unsubscribe when done\nunsubscribe1();\nunsubscribe2();\nunsubscribe3();\nunsubscribe4();\n```\n\n### Subscribe Once\n\n```typescript\neventSystem.once('level-up', (event) => {\n  console.log('First level up:', event.newLevel);\n  // This callback will only be called once\n});\n```\n\n## Error Handling\n\n### Error Codes\n\n```typescript\nimport { ErrorCode } from '@/points';\n\nconst result = await pointsAPI.addPoints(...);\n\nif (!result.success) {\n  switch (result.error?.code) {\n    case ErrorCode.INVALID_AMOUNT:\n      console.log('Amount must be greater than 0');\n      break;\n    case ErrorCode.INSUFFICIENT_BALANCE:\n      console.log('Not enough points');\n      break;\n    case ErrorCode.USER_NOT_FOUND:\n      console.log('User does not exist');\n      break;\n    case ErrorCode.INVALID_POINTS_TYPE:\n      console.log('Invalid points type');\n      break;\n    case ErrorCode.SYNC_FAILED:\n      console.log('Failed to sync with server');\n      break;\n    default:\n      console.log('Unknown error:', result.error?.message);\n  }\n}\n```\n\n### Error Response Structure\n\n```typescript\n{\n  success: false;\n  error: {\n    code: ErrorCode;           // Specific error code\n    message: string;           // Human-readable message\n    operationId: string;       // For debugging\n    timestamp: string;         // ISO timestamp\n    context?: Record<string, any>;  // Additional context\n  };\n}\n```\n\n## React Hooks\n\n### usePoints\n\n```typescript\nimport { usePoints } from '@/points';\n\nfunction MyComponent() {\n  const { points, loading, error, addPoints, getBalance } = usePoints('user-123');\n\n  if (loading) return <div>Loading...</div>;\n  if (error) return <div>Error: {error}</div>;\n\n  return (\n    <div>\n      <p>Rewards: {getBalance('rewards')}</p>\n      <button onClick={() => addPoints(100, 'rewards', 'Bonus')}>\n        Add Points\n      </button>\n    </div>\n  );\n}\n```\n\n### useAchievements\n\n```typescript\nimport { useAchievements } from '@/points';\n\nfunction AchievementsComponent() {\n  const { achievements, userAchievements, hasAchievement } = useAchievements('user-123');\n\n  return (\n    <div>\n      {achievements.map(achievement => (\n        <div key={achievement.id}>\n          <h3>{achievement.name}</h3>\n          <p>{achievement.description}</p>\n          {hasAchievement(achievement.id) && <span>✓ Unlocked</span>}\n        </div>\n      ))}\n    </div>\n  );\n}\n```\n\n### useLevel\n\n```typescript\nimport { useLevel } from '@/points';\n\nfunction LevelComponent() {\n  const { level, totalPoints, progressToNextLevel } = useLevel('user-123', 250);\n\n  return (\n    <div>\n      <p>Level: {level}</p>\n      <p>Points: {totalPoints}</p>\n      {progressToNextLevel && (\n        <div>\n          <p>Progress: {progressToNextLevel.progressPercentage.toFixed(1)}%</p>\n          <p>Next level in: {progressToNextLevel.pointsNeededForNextLevel} points</p>\n        </div>\n      )}\n    </div>\n  );\n}\n```\n\n### useTransactionHistory\n\n```typescript\nimport { useTransactionHistory } from '@/points';\n\nfunction HistoryComponent() {\n  const { transactions, filter, setFilter, currentPage, pageCount } = useTransactionHistory('user-123');\n\n  return (\n    <div>\n      <button onClick={() => setFilter({ pointsType: 'rewards' })}>\n        Show Rewards Only\n      </button>\n      \n      {transactions.map(tx => (\n        <div key={tx.id}>\n          <p>{tx.operationType}: {tx.amount} {tx.pointsType}</p>\n          <p>{tx.reason}</p>\n        </div>\n      ))}\n      \n      <p>Page {currentPage} of {pageCount}</p>\n    </div>\n  );\n}\n```\n\n## Examples\n\n### Complete User Onboarding\n\n```typescript\nimport { pointsAPI, achievementManager, levelManager, eventSystem } from '@/points';\n\nasync function onboardUser(userId: string) {\n  // Subscribe to events\n  eventSystem.on('achievement-unlocked', (event) => {\n    console.log(`Achievement unlocked: ${event.achievement.name}`);\n  });\n\n  eventSystem.on('level-up', (event) => {\n    console.log(`Level up to ${event.newLevel}!`);\n  });\n\n  // Give welcome bonus\n  await pointsAPI.addPoints(userId, 100, 'rewards', 'Welcome bonus');\n\n  // Check for achievements\n  const achievements = achievementManager.checkAndUnlockAchievements(userId, 100);\n  console.log(`Unlocked ${achievements.length} achievements`);\n\n  // Check level\n  const levelData = levelManager.getUserLevel(userId);\n  console.log(`User is now level ${levelData?.currentLevel}`);\n}\n```\n\n### Daily Reward System\n\n```typescript\nasync function giveDailyReward(userId: string) {\n  const baseReward = 50;\n  const bonusMultiplier = 1.1; // 10% bonus each day\n\n  // Get user's current level\n  const levelData = levelManager.getUserLevel(userId);\n  const multiplier = levelData?.currentLevel === 'Gold' ? 1.5 : 1;\n\n  const reward = Math.floor(baseReward * bonusMultiplier * multiplier);\n\n  const result = await pointsAPI.addPoints(\n    userId,\n    reward,\n    'rewards',\n    'Daily login reward'\n  );\n\n  if (result.success) {\n    console.log(`Gave ${reward} points to ${userId}`);\n  }\n}\n```\n\n### Leaderboard Query\n\n```typescript\nfunction getLeaderboard() {\n  const stats = new Map<string, number>();\n\n  // This would need to be implemented with Supabase queries\n  // For now, showing the pattern\n  const users = ['user-1', 'user-2', 'user-3'];\n\n  users.forEach(userId => {\n    const levelData = levelManager.getUserLevel(userId);\n    if (levelData) {\n      stats.set(userId, levelData.totalPoints);\n    }\n  });\n\n  // Sort by points descending\n  const sorted = Array.from(stats.entries())\n    .sort((a, b) => b[1] - a[1])\n    .map(([userId, points], index) => ({\n      rank: index + 1,\n      userId,\n      points\n    }));\n\n  return sorted;\n}\n```\n\n## Best Practices\n\n1. **Always handle errors**: Check `result.success` before using data\n2. **Use operation IDs**: Store `operationId` for debugging failed operations\n3. **Subscribe to events**: Use events for real-time UI updates\n4. **Unsubscribe on cleanup**: Prevent memory leaks by unsubscribing\n5. **Batch operations**: Use batch API for multiple changes\n6. **Cache data**: Use React hooks which handle caching automatically\n7. **Validate inputs**: Check amounts and user IDs before operations\n\n## Troubleshooting\n\n### Points not updating\n- Check if Supabase client is configured\n- Verify user ID is correct\n- Check browser console for errors\n- Review sync state in DevTools\n\n### Achievements not unlocking\n- Verify achievement thresholds are correct\n- Check if user has already unlocked the achievement\n- Ensure total points calculation is correct\n\n### Events not firing\n- Verify event subscription is active\n- Check if event name is correct\n- Ensure component hasn't unmounted\n\n## Support\n\nFor issues or questions, refer to:\n- Main README: `src/points/README.md`\n- Implementation Summary: `src/points/IMPLEMENTATION_SUMMARY.md`\n- Type Definitions: `src/points/types/index.ts`\n