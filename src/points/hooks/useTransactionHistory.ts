/**\n * useTransactionHistory Hook\n * React hook for viewing transaction history with filtering\n * \n * Validates: Requirements 3.1, 3.2, 3.3, 3.4\n */\n\nimport { useEffect, useState, useCallback } from 'react';\nimport { Transaction, TransactionFilter, PointsType, OperationType } from '../types';\nimport { transactionManager } from '../services/TransactionManager';\nimport { eventSystem } from '../services/EventSystem';\n\ninterface UseTransactionHistoryReturn {\n  transactions: Transaction[];\n  loading: boolean;\n  error: string | null;\n  filter: TransactionFilter;\n  setFilter: (filter: TransactionFilter) => void;\n  totalCount: number;\n  pageCount: number;\n  currentPage: number;\n  setCurrentPage: (page: number) => void;\n  refresh: () => void;\n}\n\nconst DEFAULT_PAGE_SIZE = 20;\n\nexport function useTransactionHistory(userId?: string): UseTransactionHistoryReturn {\n  const [transactions, setTransactions] = useState<Transaction[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [currentUserId, setCurrentUserId] = useState<string | null>(userId || null);\n  const [filter, setFilter] = useState<TransactionFilter>({\n    limit: DEFAULT_PAGE_SIZE,\n    offset: 0,\n  });\n  const [currentPage, setCurrentPage] = useState(1);\n  const [totalCount, setTotalCount] = useState(0);\n\n  // Load transactions\n  const loadTransactions = useCallback(() => {\n    if (!currentUserId) {\n      setLoading(false);\n      return;\n    }\n\n    try {\n      setLoading(true);\n      setError(null);\n\n      // Get all transactions for user (without pagination first to get total count)\n      const allTransactions = transactionManager.getHistory(currentUserId, {\n        pointsType: filter.pointsType,\n        operationType: filter.operationType,\n        startDate: filter.startDate,\n        endDate: filter.endDate,\n      });\n\n      setTotalCount(allTransactions.length);\n\n      // Apply pagination\n      const offset = (currentPage - 1) * DEFAULT_PAGE_SIZE;\n      const paginated = allTransactions.slice(offset, offset + DEFAULT_PAGE_SIZE);\n      setTransactions(paginated);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to load transactions');\n    } finally {\n      setLoading(false);\n    }\n  }, [currentUserId, filter, currentPage]);\n\n  // Subscribe to new transactions\n  useEffect(() => {\n    loadTransactions();\n\n    // Subscribe to points-changed events\n    const unsubscribe = eventSystem.on('points-changed', (event) => {\n      if (event.userId === currentUserId) {\n        // Reload transactions\n        loadTransactions();\n      }\n    });\n\n    return () => {\n      unsubscribe();\n    };\n  }, [currentUserId, loadTransactions]);\n\n  // Handle filter change\n  const handleFilterChange = useCallback((newFilter: TransactionFilter) => {\n    setFilter(newFilter);\n    setCurrentPage(1); // Reset to first page\n  }, []);\n\n  // Handle page change\n  const handlePageChange = useCallback((page: number) => {\n    setCurrentPage(Math.max(1, page));\n  }, []);\n\n  // Refresh transactions\n  const refresh = useCallback(() => {\n    loadTransactions();\n  }, [loadTransactions]);\n\n  // Calculate page count\n  const pageCount = Math.ceil(totalCount / DEFAULT_PAGE_SIZE);\n\n  return {\n    transactions,\n    loading,\n    error,\n    filter,\n    setFilter: handleFilterChange,\n    totalCount,\n    pageCount,\n    currentPage,\n    setCurrentPage: handlePageChange,\n    refresh,\n  };\n}\n\n/**\n * Helper hook for filtering transactions\n */\nexport function useTransactionFilter() {\n  const [filter, setFilter] = useState<TransactionFilter>({});\n\n  const updateFilter = useCallback((updates: Partial<TransactionFilter>) => {\n    setFilter((prev) => ({ ...prev, ...updates }));\n  }, []);\n\n  const clearFilter = useCallback(() => {\n    setFilter({});\n  }, []);\n\n  const filterByPointsType = useCallback((pointsType: PointsType) => {\n    setFilter((prev) => ({ ...prev, pointsType }));\n  }, []);\n\n  const filterByOperationType = useCallback((operationType: OperationType) => {\n    setFilter((prev) => ({ ...prev, operationType }));\n  }, []);\n\n  const filterByDateRange = useCallback((startDate: string, endDate: string) => {\n    setFilter((prev) => ({ ...prev, startDate, endDate }));\n  }, []);\n\n  return {\n    filter,\n    setFilter,\n    updateFilter,\n    clearFilter,\n    filterByPointsType,\n    filterByOperationType,\n    filterByDateRange,\n  };\n}\n