/**\n * useLevel Hook\n * React hook for tracking user level and progression\n * \n * Validates: Requirements 4.4, 4.5, 4.6\n */\n\nimport { useEffect, useState, useCallback } from 'react';\nimport { UserLevel, UserLevelData } from '../types';\nimport { levelManager } from '../services/LevelManager';\nimport { eventSystem } from '../services/EventSystem';\n\ninterface UseLevelReturn {\n  level: UserLevel | null;\n  totalPoints: number;\n  levelData: UserLevelData | null;\n  loading: boolean;\n  error: string | null;\n  pointsNeededForNextLevel: number;\n  progressToNextLevel: {\n    currentLevel: UserLevel;\n    nextLevel: UserLevel | null;\n    currentLevelMinPoints: number;\n    nextLevelMinPoints: number;\n    pointsInCurrentLevel: number;\n    pointsNeededForNextLevel: number;\n    progressPercentage: number;\n  } | null;\n  refresh: () => void;\n}\n\nexport function useLevel(userId?: string, totalPoints?: number): UseLevelReturn {\n  const [level, setLevel] = useState<UserLevel | null>(null);\n  const [levelData, setLevelData] = useState<UserLevelData | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [currentUserId, setCurrentUserId] = useState<string | null>(userId || null);\n  const [currentTotalPoints, setCurrentTotalPoints] = useState<number>(totalPoints || 0);\n\n  // Load level data\n  const loadLevel = useCallback(() => {\n    try {\n      setLoading(true);\n      setError(null);\n\n      if (!currentUserId) {\n        setLoading(false);\n        return;\n      }\n\n      // Get or initialize user level\n      let data = levelManager.getUserLevel(currentUserId);\n      if (!data) {\n        data = levelManager.initializeUserLevel(currentUserId, currentTotalPoints);\n      }\n\n      setLevelData(data);\n      setLevel(data.currentLevel);\n    } catch (err) {\n      setError(err instanceof Error ? err.message : 'Failed to load level');\n    } finally {\n      setLoading(false);\n    }\n  }, [currentUserId, currentTotalPoints]);\n\n  // Subscribe to level-up events\n  useEffect(() => {\n    loadLevel();\n\n    // Subscribe to level-up events\n    const unsubscribe = eventSystem.on('level-up', (event) => {\n      if (event.userId === currentUserId) {\n        setLevel(event.newLevel);\n        const data = levelManager.getUserLevel(currentUserId);\n        if (data) {\n          setLevelData(data);\n        }\n      }\n    });\n\n    // Subscribe to points-changed events to update total points\n    const unsubscribePoints = eventSystem.on('points-changed', (event) => {\n      if (event.userId === currentUserId) {\n        // Update total points (sum of all point types)\n        // This would need to be calculated from the actual points data\n        loadLevel();\n      }\n    });\n\n    return () => {\n      unsubscribe();\n      unsubscribePoints();\n    };\n  }, [currentUserId, loadLevel]);\n\n  // Calculate points needed for next level\n  const pointsNeededForNextLevel = levelData\n    ? levelManager.getPointsNeededForNextLevel(levelData.totalPoints)\n    : 0;\n\n  // Get progress to next level\n  const progressToNextLevel = levelData ? levelManager.getProgressToNextLevel(levelData.totalPoints) : null;\n\n  // Refresh level data\n  const refresh = useCallback(() => {\n    loadLevel();\n  }, [loadLevel]);\n\n  return {\n    level,\n    totalPoints: levelData?.totalPoints || 0,\n    levelData,\n    loading,\n    error,\n    pointsNeededForNextLevel,\n    progressToNextLevel,\n    refresh,\n  };\n}\n